---
title: "Getting Started with ENMTools v2.0"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with ENMTools v2.0}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ENMTools)
```

This vignette is about new feature in ENMTools in version 2.0. It can help for user's migrating from version 1.0, and is also a testing ground for the new feature. 
Firstly, the datasets included with ENMTools in version 1.0, `iberolacerta.clade` and `euro.worldclim`, are no longer accessed through the `data()`, command, but are now internal to the package. That means if `ENMTools` is loaded that you can simply call the datasets directly without having to explicitly load them with `data()` first.
Second, ENMTools uses the `terra` package for geospatial raster data, instead of the `raster` package, which has now been deprecated. The internal datasets have been updated to reflect this. For example, `euro.worldclim` is now a "SpatRaster" object from `terra` instead of a "RasterLayer" from `raster`. The good news is that objects from `terra` work very similarly to objects from `raster` (which makes sense since `terra` is from the same developers as `raster`).

```{r first_test}
monticola <- iberolacerta.clade$species$monticola
cyreni <- iberolacerta.clade$species$cyreni
env <- euro.worldclim
env
```
Model fitting functions from ENMTools still function much as they did before once you have an `enmtools.species` object that has been updated to use `terra` instead of `raster`. At least, from you, the users, perspective, they work the same. Under the hood, many changes have been made, but you don't need to know about that now. Those changes enable some more advanced features that we will talke about later, but for now if you just want ENMTools to behave the way you are used to from ENTools 1.0, the good news is that it will. Let's try running a GLM model.

```{r run_glm, eval = FALSE}
monticola.glm <- enmtools.glm(species = monticola, env = env, f = pres ~ bio1 + bio12 + bio7, test.prop = 0.2)
monticola.glm


```

Now to test hypervolume.

```{r hypervolum_test, eval=FALSE}
monticola.hyper <- enmtools.hypervolume(species = monticola, env = env[[c("bio1", "bio12", "bio7")]])
monticola.ranger <- enmtools.rf.ranger(species = monticola, env = env, f = pres ~ bio1 + bio12 + bio7, test.prop = 0.2)
```

RTS:

```{r rts}
monticola.gam.rts <- enmtools.gam(species = monticola, env = env, f = pres ~ bio1 + bio12 + bio7, test.prop = 0, rts.reps = 10)
monticola.gam.rts$rts.test
```

## Tidymodels

```{r tidy_testing}
monti_recipe <- recipe(monticola, env = euro.worldclim)
monti_recipe

test <- enmtools.tidy(monticola, euro.worldclim)
test

tt <- enmtools.tidy(monticola, euro.worldclim, model = "rf.ranger", test.prop = 0.2, model_args = list(trees = 1000))
terra::plot(tt$suitability)

bm <- bench::mark(tt1 <- enmtools.tidy(monticola, euro.worldclim, model = "rf.ranger", test.prop = 0.2, rts.reps = 10),
            tt2 <- enmtools.rf.ranger(monticola, euro.worldclim, test.prop = 0.2, rts.reps = 10),
            check = FALSE)
bm

tt <- enmtools.tidy(monticola, euro.worldclim, model = parsnip::boost_tree("classification"), test.prop = 0.2, rts.reps = 10)

tt2 <- enmtools.tidy(monticola, euro.worldclim, f = ~ bio1 + bio9, model = "bc", test.prop = 0.2, rts.reps = 10)
tt2 <- enmtools.tidy(monticola, euro.worldclim, model = "bc", test.prop = 0.2, rts.reps = 10)
```
